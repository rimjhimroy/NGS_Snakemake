###################
##  Transposome  ##
###################

import os, subprocess
import configparser
from Transposome import *

       
# Install perl if version is too low (as on our cluster)
rule install_perl:
   output: CONFIG["executables"]["perl"]
   shell:
        "wget --no-check-certificate -O - http://install.perlbrew.pl | bash && "
        "" + CONFIG["base"]["perl_brew"] + "/bin/perlbrew " + CONFIG["base"]["perl_brew_options"] + " install " + CONFIG["base"]["perl_version"] + " && "
        "ln -fs " + CONFIG["base"]["perl_brew"] + "perls/perl-" + CONFIG["base"]["perl_version"] + "/bin/perl" + CONFIG["base"]["perl_version"] + " " + CONFIG["base"]["perl_brew"] + "perls/perl-" + CONFIG["base"]["perl_version"] + "/bin/perl && "
        "sed -i 's|export PERLBREW_BASHRC_VERSION|set +u\\nexport PERLBREW_BASHRC_VERSION|' " + CONFIG["base"]["perl_brew"] + "etc/bashrc && "
        "source " + CONFIG["base"]["perl_brew"] + "etc/bashrc && "
        "perlbrew switch " + CONFIG["base"]["perl_version"] + " && "
        "cat " + CONFIG["base"]["perl_brew"] + "etc/bashrc >> {rules.bashrc.output} && "
        "echo 'perlbrew switch " + CONFIG["base"]["perl_version"] + "' >>  {rules.bashrc.output} && "
        "touch {output};"

# Create local Perl library
rule install_perl_cpanm:
    input:
        PERL=rules.install_perl.output
    output: CONFIG["executables"]["cpanm"]
    shell:
        "source {rules.bashrc.output} && "
        "perlbrew install-cpanm && "
        "touch {output}"

# Install necessary Perl libraries
rule install_perl_libs:
    input:
        rules.install_perl_cpanm.output,
        rules.install_perl.output
    output: CONFIG["base"]["perl_install"] + "lib/done"
    run:
        for lib in CONFIG["base"]["perl_libs"]:
            shell("source  {rules.bashrc.output} ; cpanm "+ CONFIG["base"]["perl_cpanm_options"] + " " + lib)
        shell("touch " + CONFIG["base"]["perl_install"] + "lib/done")

rule install_transposome:
    input:
        rules.install_perl_libs.output,
        PERL=rules.install_perl.output
    output: ""  + CONFIG["executables"]["transposome"] + "/bin/transposome"
    shell:
        "TEMPDIR=`mktemp -p " + CONFIG["base"]["download_dir"] + " -d` && "
        "cd $TEMPDIR && "
        "wget https://github.com/sestaton/Transposome/archive/v0.09.7.tar.gz && "
        "tar xzf v0.09.7.tar.gz && cd Transposome-* && "
        "curl -L cpanmin.us | {input.PERL} - --installdeps . && {input.PERL} Makefile.PL && make && make install && "
        "mv -f * " + CONFIG["executables"]["transposome"] + " && cd .. && rm -rf Transposome* "

rule transposome:
    input: 
        rules.install_transposome.output
    params : configured = read_yml(CONFIG, "config.yml")
    output: "" + CONFIG["base"]["output"] + "/config.yml"
    shell:
        "source {rules.bashrc.output} && "
        "mkdir -p "+ CONFIG["base"]["output"] + " && "
        'echo "{params.configured}" > ' + CONFIG["base"]["output"] + "/config.yml && "
        "{rules.install_transposome.output} --config "+ CONFIG["base"]["output"] + "/config.yml"
    